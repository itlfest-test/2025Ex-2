<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´° - å­¦ç¥­ã‚¤ãƒ™ãƒ³ãƒˆæ¤œç´¢</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="max-w-4xl mx-auto p-4">
    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
      <a href="index.html" id="back-to-search" style="color: #2563eb; text-decoration: none; font-size: 14px;">â† æ¤œç´¢ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
      <button id="add-to-calendar-btn" style="background: #16a34a; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ </button>
    </div>

    <div id="event-detail-content" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <div style="text-align: center; padding: 40px; color: #666;">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>

  <script>
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('id');

    // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã«æ¤œç´¢æ¡ä»¶ã‚’ä¿æŒ
    const backBtn = document.getElementById('back-to-search');
    const savedFilters = localStorage.getItem('searchFilters');
    if (savedFilters) {
      const filters = JSON.parse(savedFilters);
      const params = new URLSearchParams();
      if (filters.university) params.set('uni', filters.university);
      if (filters.category) params.set('cat', filters.category);
      if (filters.field) params.set('field', filters.field);
      if (filters.date) params.set('date', filters.date);
      if (params.toString()) {
        backBtn.href = `index.html?${params.toString()}`;
      }
    }

    let currentEvent = null;

    if (!eventId) {
      document.getElementById('event-detail-content').innerHTML = `
        <div style="text-align: center; padding: 40px; color: #c33;">
          <h2>ã‚¨ãƒ©ãƒ¼</h2>
          <p>ã‚¤ãƒ™ãƒ³ãƒˆIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
          <a href="index.html" style="color: #2563eb;">æ¤œç´¢ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
        </div>
      `;
    } else {
      loadEventDetail(eventId);
    }

    async function loadEventDetail(id) {
      try {
        const response = await fetch('data/events.json');
        const events = await response.json();
        const event = events.find(e => e.id == id);

        if (!event) {
          document.getElementById('event-detail-content').innerHTML = `
            <div style="text-align: center; padding: 40px; color: #c33;">
              <h2>ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h2>
              <p>æŒ‡å®šã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆï¼ˆID: ${id}ï¼‰ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚</p>
              <a href="index.html" style="color: #2563eb;">æ¤œç´¢ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
            </div>
          `;
          return;
        }

        currentEvent = event;

        // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ã‚’è¡¨ç¤º
        const name = event.name || event["ä¼ç”»å"] || "(ç„¡é¡Œ)";
        const subtitle = event.subtitle || event["ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«"] || "";
        const description = event.description || event["èª¬æ˜"] || "";
        const university = event.university || event["å¤§å­¦"] || "";
        const category = event.category || event["ã‚«ãƒ†ã‚´ãƒª"] || "";
        const field = event.field || event["åˆ†é‡"] || "";
        const startDatetime = event.startDatetime || event.start_datetime || event["start_datetime"] || "";
        const endDatetime = event.endDatetime || event.end_datetime || event["end_datetime"] || "";
        const location = event.location || event["å ´æ‰€"] || "";

        // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        let dateTimeStr = "";
        if (startDatetime) {
          try {
            const start = new Date(startDatetime);
            const year = start.getFullYear();
            const month = start.getMonth() + 1;
            const day = start.getDate();
            const weekdays = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
            const weekday = weekdays[start.getDay()];
            const startHour = String(start.getHours()).padStart(2, '0');
            const startMin = String(start.getMinutes()).padStart(2, '0');
            
            dateTimeStr = `${year}å¹´${month}æœˆ${day}æ—¥ï¼ˆ${weekday}ï¼‰ ${startHour}:${startMin}`;
            
            if (endDatetime) {
              const end = new Date(endDatetime);
              const endHour = String(end.getHours()).padStart(2, '0');
              const endMin = String(end.getMinutes()).padStart(2, '0');
              dateTimeStr += `ï½${endHour}:${endMin}`;
            }
          } catch (e) {
            dateTimeStr = startDatetime;
          }
        }

        document.getElementById('event-detail-content').innerHTML = `
          <h1 style="font-size: 28px; font-weight: bold; color: #1e40af; margin-bottom: 8px;">${escapeHtml(name)}</h1>
          ${subtitle ? `<p style="font-size: 18px; color: #666; margin-bottom: 20px;">${escapeHtml(subtitle)}</p>` : ''}
          
          <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px;">
            <span style="background: #dbeafe; color: #1e40af; padding: 6px 12px; border-radius: 4px; font-size: 14px;">${escapeHtml(university)}</span>
            <span style="background: #fef3c7; color: #92400e; padding: 6px 12px; border-radius: 4px; font-size: 14px;">${escapeHtml(category)}</span>
            <span style="background: #e0e7ff; color: #4338ca; padding: 6px 12px; border-radius: 4px; font-size: 14px;">${escapeHtml(field)}</span>
          </div>

          ${dateTimeStr ? `
            <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
              <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">ğŸ“… é–‹å‚¬æ—¥æ™‚</div>
              <div style="color: #1f2937;">${escapeHtml(dateTimeStr)}</div>
            </div>
          ` : ''}

          ${location ? `
            <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
              <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">ğŸ“ å ´æ‰€</div>
              <div style="color: #1f2937;">${escapeHtml(location)}</div>
            </div>
          ` : ''}

          <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <div style="font-weight: 600; color: #374151; margin-bottom: 12px; font-size: 18px;">ğŸ“ è©³ç´°èª¬æ˜</div>
            <div style="color: #1f2937; line-height: 1.8; white-space: pre-wrap;">${escapeHtml(description)}</div>
          </div>

          <div style="text-align: center; margin-top: 30px;">
            <a href="index.html" style="display: inline-block; background: #2563eb; color: white; padding: 12px 32px; border-radius: 8px; text-decoration: none; font-weight: 500;">æ¤œç´¢ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
          </div>
        `;

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        setupCalendarButton();

      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('event-detail-content').innerHTML = `
          <div style="text-align: center; padding: 40px; color: #c33;">
            <h2>ã‚¨ãƒ©ãƒ¼</h2>
            <p>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>
            <a href="index.html" style="color: #2563eb;">æ¤œç´¢ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
          </div>
        `;
      }
    }

    function setupCalendarButton() {
      const btn = document.getElementById('add-to-calendar-btn');
      if (!btn || !currentEvent) return;

      btn.addEventListener('click', async () => {
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
        const calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
        
        const startDatetime = currentEvent.startDatetime || currentEvent.start_datetime || currentEvent["start_datetime"];
        const endDatetime = currentEvent.endDatetime || currentEvent.end_datetime || currentEvent["end_datetime"];
        const university = currentEvent.university || currentEvent["å¤§å­¦"];

        if (!startDatetime) {
          alert('ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã«ã¯é–‹å‚¬æ—¥æ™‚ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
          return;
        }

        // æ™‚é–“ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
        const conflicts = checkTimeConflicts(calendarEvents, startDatetime, endDatetime, university);
        
        if (conflicts.length > 0) {
          let message = 'âš ï¸ ä»¥ä¸‹ã®ã‚¤ãƒ™ãƒ³ãƒˆã¨æ™‚é–“ãŒé‡è¤‡ã—ã¦ã„ã¾ã™ï¼š\n\n';
          conflicts.forEach(c => {
            message += `â€¢ ${c.name}\n`;
            if (c.needsTransit) {
              message += `  â†’ ç•°ãªã‚‹ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã¸ã®ç§»å‹•ãŒå¿…è¦ã§ã™\n`;
            }
          });
          message += '\nãã‚Œã§ã‚‚è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ';
          
          if (!confirm(message)) {
            return;
          }
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ 
        calendarEvents.push({
          id: currentEvent.id,
          name: currentEvent.name || currentEvent["ä¼ç”»å"],
          university: university,
          startDatetime: startDatetime,
          endDatetime: endDatetime
        });

        localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
        
        btn.textContent = 'âœ“ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ æ¸ˆã¿';
        btn.style.background = '#6b7280';
        btn.disabled = true;

        alert('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ ã—ã¾ã—ãŸï¼');
      });
    }

    function checkTimeConflicts(calendarEvents, newStart, newEnd, newUniversity) {
      const conflicts = [];
      const newStartTime = new Date(newStart);
      const newEndTime = newEnd ? new Date(newEnd) : new Date(newStartTime.getTime() + 60*60*1000); // çµ‚äº†æ™‚åˆ»ãŒãªã‘ã‚Œã°1æ™‚é–“å¾Œ

      calendarEvents.forEach(event => {
        const eventStart = new Date(event.startDatetime);
        const eventEnd = event.endDatetime ? new Date(event.endDatetime) : new Date(eventStart.getTime() + 60*60*1000);

        // æ™‚é–“ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
        if (newStartTime < eventEnd && newEndTime > eventStart) {
          const needsTransit = event.university !== newUniversity;
          conflicts.push({
            name: event.name,
            needsTransit: needsTransit
          });
        }
      });

      return conflicts;
    }

    function escapeHtml(str) {
      if (!str && str !== 0) return "";
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }
  </script>
</body>
</html>
